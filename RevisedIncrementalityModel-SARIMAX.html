<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Revised Incrementality Model</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="RevisedIncrementalityModel-SARIMAX_files/libs/clipboard/clipboard.min.js"></script>
<script src="RevisedIncrementalityModel-SARIMAX_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="RevisedIncrementalityModel-SARIMAX_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="RevisedIncrementalityModel-SARIMAX_files/libs/quarto-html/popper.min.js"></script>
<script src="RevisedIncrementalityModel-SARIMAX_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="RevisedIncrementalityModel-SARIMAX_files/libs/quarto-html/anchor.min.js"></script>
<link href="RevisedIncrementalityModel-SARIMAX_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="RevisedIncrementalityModel-SARIMAX_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="RevisedIncrementalityModel-SARIMAX_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="RevisedIncrementalityModel-SARIMAX_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="RevisedIncrementalityModel-SARIMAX_files/libs/bootstrap/bootstrap-81267100e462c21b3d6c0d5bf76a3417.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Revised Incrementality Model</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="revised-incrementality-model" class="level1">
<h1>Revised Incrementality Model</h1>
<div id="a2670180" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># !pip install openpyxl</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># !pip install ast</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">Importing all libraries to execute code</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">"""</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Suppress warnings</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Basic imports</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ast</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Data visualization</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.ticker <span class="im">as</span> mticker</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.dates <span class="im">import</span> date2num</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.ticker <span class="im">import</span> FuncFormatter</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Statistics</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.distributions.empirical_distribution <span class="im">import</span> ECDF</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.api <span class="im">import</span> ExponentialSmoothing</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.stattools <span class="im">import</span> adfuller</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.graphics.tsaplots <span class="im">import</span> plot_acf, plot_pacf</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.seasonal <span class="im">import</span> seasonal_decompose</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Prophet (Time Series Forecasting)</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> prophet <span class="im">as</span> Prophet</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Time Series Analysis</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pmdarima <span class="im">import</span> auto_arima</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Machine Learning: XGBoost</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> xgboost <span class="im">as</span> xgb</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> xgboost.sklearn <span class="im">import</span> XGBRegressor  <span class="co"># Wrapper</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split, GridSearchCV, RandomizedSearchCV</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error, mean_absolute_error, r2_score</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Excel File Manipulation</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openpyxl <span class="im">import</span> load_workbook</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openpyxl.utils.dataframe <span class="im">import</span> dataframe_to_rows</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> openpyxl</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Data Profiling</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataprofiler <span class="im">import</span> Profiler, Data</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Custom Function (from original code block)</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> millions(x, pos):</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f'</span><span class="sc">{</span>x <span class="op">*</span> <span class="fl">1e-6</span><span class="sc">:.1f}</span><span class="ss">M'</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>qualitative_colors <span class="op">=</span> [</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#1f77b4"</span>,  <span class="co"># Blue</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#ff7f0e"</span>,  <span class="co"># Orange</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#2ca02c"</span>,  <span class="co"># Green</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#d62728"</span>,  <span class="co"># Red</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#9467bd"</span>,  <span class="co"># Purple</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#8c564b"</span>,  <span class="co"># Brown</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#e377c2"</span>,  <span class="co"># Pink</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#7f7f7f"</span>,  <span class="co"># Gray</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#bcbd22"</span>,  <span class="co"># Olive</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">"#17becf"</span>   <span class="co"># Cyan</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="rossman-store-sales-data" class="level2">
<h2 class="anchored" data-anchor-id="rossman-store-sales-data"><strong>Rossman Store Sales Data</strong></h2>
<p><strong>Rossmann</strong>, is one of the largest drugstore chains in Europe, headquartered in Burgwedel, Germany. Founded in 1972 by Dirk Rossmann, the company has grown significantly and operates over 4,700 stores across several countries, including Germany, Poland, Hungary, the Czech Republic, Albania, Turkey, Kosovo, and Spain.</p>
<p>In <strong>2015</strong>, Rossman held a competition on <a href="https://www.kaggle.com/competitions/rossmann-store-sales/overview">Kaggle</a>. They uploaded sales data along with auxillary information for over <strong>1000</strong> stores, with the aim of finding submissions from competitors who develop the best model that fit sales and forecast the next 6 weeks of sales.</p>
<p>The competition was evaluated on Root Mean Square Percentage error (RMSPE). Calculated as: <span class="math display">\[
\text{RMSPE} = \sqrt{\frac{1}{n} \sum_{i=1}^n \left( \frac{y_i - \hat{y}_i}{y_i} \right)^2}
\]</span></p>
<p><strong>Where:</strong></p>
<p><span class="math display">\[
y_i \text{ is the actual (observed) value for the } i\text{-th data point,}
\]</span></p>
<p><span class="math display">\[
\hat{y}_i \text{ is the predicted value for the } i\text{-th data point,}
\]</span></p>
<p><span class="math display">\[
n \text{ is the total number of data points in the dataset.}
\]</span></p>
<section id="dataset" class="level4">
<h4 class="anchored" data-anchor-id="dataset">Dataset</h4>
<p>The dataset provided is constituted of 3 files: - <strong>Train</strong> - This includes sales data for 1,115 stores. With granularity of <strong>Sales per Day per Store</strong>. - <strong>Test</strong> - This includes sales data for 1,115 stores. With granularity of <strong>Sales per Day per Store</strong>. - <strong>Store</strong> - This dataset has auxillary data.</p>
<div id="49a7aae4" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> pd.read_csv(<span class="st">"train.csv"</span>, </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                    parse_dates <span class="op">=</span> <span class="va">True</span>, index_col <span class="op">=</span> <span class="st">'Date'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># additional store data</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>store <span class="op">=</span> pd.read_csv(<span class="st">"store.csv"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># time series as indexes</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># dataTypeAnalyze = Data("train.csv")</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># profile = Profiler(dataTypeAnalyze)</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># human_readable_report = profile.report(report_options={"output_format":"pretty"})</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># print(json.dumps(human_readable_report, indent=4))</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>display(train)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>display(store)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># for column in train.columns:</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     unique_values = train[column].unique()</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(f"Unique values in column '{column}': {unique_values}")</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co"># print(train.shape)</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co"># for column in store.columns:</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co">#     unique_values = store[column].unique()</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(f"Unique values in column '{column}': {unique_values}")</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co"># print(store.shape)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Store</th>
<th data-quarto-table-cell-role="th">DayOfWeek</th>
<th data-quarto-table-cell-role="th">Sales</th>
<th data-quarto-table-cell-role="th">Customers</th>
<th data-quarto-table-cell-role="th">Open</th>
<th data-quarto-table-cell-role="th">Promo</th>
<th data-quarto-table-cell-role="th">StateHoliday</th>
<th data-quarto-table-cell-role="th">SchoolHoliday</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2015-07-31</td>
<td>1</td>
<td>5</td>
<td>5263</td>
<td>555</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2015-07-31</td>
<td>2</td>
<td>5</td>
<td>6064</td>
<td>625</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2015-07-31</td>
<td>3</td>
<td>5</td>
<td>8314</td>
<td>821</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2015-07-31</td>
<td>4</td>
<td>5</td>
<td>13995</td>
<td>1498</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2015-07-31</td>
<td>5</td>
<td>5</td>
<td>4822</td>
<td>559</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2013-01-01</td>
<td>1111</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>a</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2013-01-01</td>
<td>1112</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>a</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2013-01-01</td>
<td>1113</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>a</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2013-01-01</td>
<td>1114</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>a</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2013-01-01</td>
<td>1115</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>a</td>
<td>1</td>
</tr>
</tbody>
</table>

<p>1017209 rows × 8 columns</p>
</div>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Store</th>
<th data-quarto-table-cell-role="th">StoreType</th>
<th data-quarto-table-cell-role="th">Assortment</th>
<th data-quarto-table-cell-role="th">CompetitionDistance</th>
<th data-quarto-table-cell-role="th">CompetitionOpenSinceMonth</th>
<th data-quarto-table-cell-role="th">CompetitionOpenSinceYear</th>
<th data-quarto-table-cell-role="th">Promo2</th>
<th data-quarto-table-cell-role="th">Promo2SinceWeek</th>
<th data-quarto-table-cell-role="th">Promo2SinceYear</th>
<th data-quarto-table-cell-role="th">PromoInterval</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>c</td>
<td>a</td>
<td>1270.0</td>
<td>9.0</td>
<td>2008.0</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>a</td>
<td>a</td>
<td>570.0</td>
<td>11.0</td>
<td>2007.0</td>
<td>1</td>
<td>13.0</td>
<td>2010.0</td>
<td>Jan,Apr,Jul,Oct</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>a</td>
<td>a</td>
<td>14130.0</td>
<td>12.0</td>
<td>2006.0</td>
<td>1</td>
<td>14.0</td>
<td>2011.0</td>
<td>Jan,Apr,Jul,Oct</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>c</td>
<td>c</td>
<td>620.0</td>
<td>9.0</td>
<td>2009.0</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>a</td>
<td>a</td>
<td>29910.0</td>
<td>4.0</td>
<td>2015.0</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1110</td>
<td>1111</td>
<td>a</td>
<td>a</td>
<td>1900.0</td>
<td>6.0</td>
<td>2014.0</td>
<td>1</td>
<td>31.0</td>
<td>2013.0</td>
<td>Jan,Apr,Jul,Oct</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1111</td>
<td>1112</td>
<td>c</td>
<td>c</td>
<td>1880.0</td>
<td>4.0</td>
<td>2006.0</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1112</td>
<td>1113</td>
<td>a</td>
<td>c</td>
<td>9260.0</td>
<td>NaN</td>
<td>NaN</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1113</td>
<td>1114</td>
<td>a</td>
<td>c</td>
<td>870.0</td>
<td>NaN</td>
<td>NaN</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1114</td>
<td>1115</td>
<td>d</td>
<td>c</td>
<td>5350.0</td>
<td>NaN</td>
<td>NaN</td>
<td>1</td>
<td>22.0</td>
<td>2012.0</td>
<td>Mar,Jun,Sept,Dec</td>
</tr>
</tbody>
</table>

<p>1115 rows × 10 columns</p>
</div>
</div>
</div>
</section>
<section id="train-feature-descriptions" class="level4">
<h4 class="anchored" data-anchor-id="train-feature-descriptions"><strong>Train Feature Descriptions</strong></h4>
<p>This table provides an overview of the key features and their descriptions:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 18%">
<col style="width: 81%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Feature</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Sales</strong></td>
<td>The turnover for any given day (target variable).</td>
</tr>
<tr class="even">
<td><strong>Customers</strong></td>
<td>The number of customers on a given day.</td>
</tr>
<tr class="odd">
<td><strong>Open</strong></td>
<td>Indicates whether the store was open: <strong>0</strong> = closed, <strong>1</strong> = open.</td>
</tr>
<tr class="even">
<td><strong>Promo</strong></td>
<td>Indicates whether a store was running a promotion on that day.</td>
</tr>
<tr class="odd">
<td><strong>StateHoliday</strong></td>
<td>Indicates a state holiday. Normally, all stores, with few exceptions, are closed on state holidays.</td>
</tr>
<tr class="even">
<td><strong>SchoolHoliday</strong></td>
<td>Indicates if the store was affected by the closure of public schools on that day.</td>
</tr>
</tbody>
</table>
<hr>
<section id="notes" class="level5">
<h5 class="anchored" data-anchor-id="notes"><strong>Notes</strong></h5>
<ul>
<li><strong>Sales</strong> is the target variable in this dataset.</li>
<li>Features like <strong>StateHoliday</strong> and <strong>SchoolHoliday</strong> provide contextual information about external factors affecting the store's operations.</li>
<li><strong>Open</strong> is a binary indicator that tells whether the store was operating on a given day.</li>
</ul>
</section>
</section>
<section id="store-feature-descriptions" class="level4">
<h4 class="anchored" data-anchor-id="store-feature-descriptions"><strong>Store Feature Descriptions</strong></h4>
<p>This table provides detailed information about the features in the dataset:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 21%">
<col style="width: 78%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Feature</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Store</strong></td>
<td>A unique ID for each store.</td>
</tr>
<tr class="even">
<td><strong>StoreType</strong></td>
<td>Differentiates between 4 different store models: <strong>a</strong>, <strong>b</strong>, <strong>c</strong>, <strong>d</strong>.</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
</tr>
<tr class="even">
<td><strong>Assortment</strong></td>
<td>Describes the assortment level: <strong>a</strong> = basic, <strong>b</strong> = extra, <strong>c</strong> = extended.</td>
</tr>
<tr class="odd">
<td><strong>CompetitionDistance</strong></td>
<td>Distance in meters to the nearest competitor store.</td>
</tr>
<tr class="even">
<td><strong>CompetitionOpenSince[Month/Year]</strong></td>
<td>Gives the approximate year and month when the nearest competitor store was opened.</td>
</tr>
<tr class="odd">
<td><strong>Promo2</strong></td>
<td>Indicates if the store is participating in a continuing promotion: <strong>0</strong> = not participating, <strong>1</strong> = participating.</td>
</tr>
<tr class="even">
<td><strong>Promo2Since[Year/Week]</strong></td>
<td>Describes the year and calendar week when the store started participating in Promo2.</td>
</tr>
<tr class="odd">
<td><strong>PromoInterval</strong></td>
<td>Describes the months when Promo2 starts. For example, <strong>"Feb, May, Aug, Nov"</strong> means Promo2 begins in these months annually.</td>
</tr>
</tbody>
</table>
<hr>
<section id="notes-1" class="level5">
<h5 class="anchored" data-anchor-id="notes-1"><strong>Notes</strong></h5>
<ul>
<li><strong>StoreType</strong> and <strong>Assortment</strong> provide categorical details about the type of store and the variety of products offered.</li>
<li><strong>CompetitionDistance</strong> and <strong>CompetitionOpenSince</strong> offer insights into how competition impacts sales.</li>
<li><strong>Promo2</strong> and related features (<strong>Promo2Since</strong> and <strong>PromoInterval</strong>) describe ongoing promotional activities that vary across stores.</li>
<li>These features are used to analyze store performance and customer behavior across different contexts.</li>
</ul>
</section>
</section>
<section id="we-will-now-do-some-data-cleaningwrangling-and-visualize-the-data" class="level4">
<h4 class="anchored" data-anchor-id="we-will-now-do-some-data-cleaningwrangling-and-visualize-the-data"><strong>We will now do some data cleaning/wrangling and visualize the data</strong></h4>
<div id="9f90c5df" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"The data runs over "</span>, train.index.nunique(), <span class="st">"days"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"The unique number of stores "</span>, train[<span class="st">'Store'</span>].nunique())</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>train[<span class="st">'Year'</span>] <span class="op">=</span> train.index.year</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>train[<span class="st">'Month'</span>] <span class="op">=</span> train.index.month</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>train[<span class="st">'Day'</span>] <span class="op">=</span> train.index.day</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>train[<span class="st">'WeekOfYear'</span>] <span class="op">=</span> train.index.isocalendar().week </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># adding new variable</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>train[<span class="st">'SalePerCustomer'</span>] <span class="op">=</span> train[<span class="st">'Sales'</span>]<span class="op">/</span>train[<span class="st">'Customers'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The data runs over  942 days
The unique number of stores  1115</code></pre>
</div>
</div>
<div id="efb30466" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>train_aggregated <span class="op">=</span> train.groupby(train.index).agg(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    Total_Sales<span class="op">=</span>(<span class="st">'Sales'</span>, <span class="st">'sum'</span>),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    Total_Customers<span class="op">=</span>(<span class="st">'Customers'</span>, <span class="st">'sum'</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style<span class="op">=</span><span class="st">"darkgrid"</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the responses for different events and regions</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Reuse to format timeseries graphs -----------------</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">6</span>))</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Total Sales"</span>,color <span class="op">=</span> <span class="st">'#858585'</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>,color <span class="op">=</span> <span class="st">'#858585'</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>formatter <span class="op">=</span> FuncFormatter(millions)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>plt.gca().yaxis.set_major_formatter(formatter)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Daily Aggregrated Total Sales by Date"</span>, color <span class="op">=</span> <span class="st">'black'</span>,fontweight <span class="op">=</span> <span class="st">'bold'</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>plt.annotate(</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Yearly Seasonality'</span>, </span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    xy<span class="op">=</span>(pd.to_datetime(<span class="st">'2013-12-10'</span>), <span class="dv">14000000</span>),  <span class="co"># Point near the 80% mark</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    xytext<span class="op">=</span>(date2num(pd.to_datetime(<span class="st">'2013-01-01'</span>)), <span class="dv">14300000</span>), </span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    arrowprops<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'black'</span>,edgecolor<span class="op">=</span><span class="st">'black'</span>, arrowstyle<span class="op">=</span><span class="st">"-&gt;"</span>, lw<span class="op">=</span><span class="fl">1.5</span>),</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">'black'</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>plt.annotate(</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">''</span>, </span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    xy<span class="op">=</span>(pd.to_datetime(<span class="st">'2013-01-19'</span>), <span class="dv">10000000</span>),  <span class="co"># Point near the 80% mark</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    xytext<span class="op">=</span>(date2num(pd.to_datetime(<span class="st">'2013-01-01'</span>)), <span class="dv">14300000</span>), </span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    arrowprops<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'black'</span>,edgecolor<span class="op">=</span><span class="st">'black'</span>, arrowstyle<span class="op">=</span><span class="st">"-&gt;"</span>, lw<span class="op">=</span><span class="fl">1.5</span>),</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">'black'</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"Date"</span>, y<span class="op">=</span><span class="st">"Total_Sales"</span>,</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>             data<span class="op">=</span>train_aggregated)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>train[<span class="st">'DayOfWeek'</span>] <span class="op">=</span> train.index.dayofweek  <span class="co"># 0 = Monday, 6 = Sunday</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate sales by DayOfWeek</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>sales_by_dow <span class="op">=</span> train.groupby(<span class="st">'DayOfWeek'</span>)[<span class="st">'Sales'</span>].<span class="bu">sum</span>().reset_index()</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>sns.barplot(x<span class="op">=</span><span class="st">'DayOfWeek'</span>, y<span class="op">=</span><span class="st">'Sales'</span>, data<span class="op">=</span>sales_by_dow, palette<span class="op">=</span><span class="st">'rocket'</span>)</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels and title</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Reuse to format timeseries graphs -----------------</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Total Sales"</span>,color <span class="op">=</span> <span class="st">'#858585'</span>)</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>,color <span class="op">=</span> <span class="st">'#858585'</span>)</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a><span class="co">#--------------</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Day of the Week'</span>)</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Total Sales'</span>)</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Total Sales by Day of the Week'</span>, color <span class="op">=</span> <span class="st">'black'</span>,fontweight <span class="op">=</span> <span class="st">'bold'</span>)</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>plt.xticks(ticks<span class="op">=</span><span class="bu">range</span>(<span class="dv">7</span>), labels<span class="op">=</span>[<span class="st">'Mon'</span>, <span class="st">'Tue'</span>, <span class="st">'Wed'</span>, <span class="st">'Thu'</span>, <span class="st">'Fri'</span>, <span class="st">'Sat'</span>, <span class="st">'Sun'</span>])</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>plt.gca().yaxis.set_major_formatter(mticker.FuncFormatter(<span class="kw">lambda</span> x, _: <span class="ss">f'$</span><span class="sc">{</span>x<span class="op">*</span><span class="fl">1e-6</span><span class="sc">:,.0f}</span><span class="ss">M'</span>))</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RevisedIncrementalityModel-SARIMAX_files/figure-html/cell-5-output-1.png" width="999" height="529" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RevisedIncrementalityModel-SARIMAX_files/figure-html/cell-5-output-2.png" width="853" height="381" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="explatory-data-analysis-eda" class="level2">
<h2 class="anchored" data-anchor-id="explatory-data-analysis-eda"><strong>Explatory Data Analysis (EDA)</strong></h2>
<p>Displaying the data we can see a following interesting features from the sales data. Primarily: - <strong>Seasonality</strong></p>
<pre><code>- ***Yearly*** - We can see seasonality between the start and end of the calendar year.
- ***Weekly*** - We can also see weekly seasonality, with sales peaking on Mondays, and troughs on Sundays. [As shown in the graph above]</code></pre>
<ul>
<li><strong>Cycles</strong> - The data exhibits rises and falls that aren't neccassarily fixed in frequency. Often related to business cycles. This is most likely due to promotions.</li>
<li><strong>Cycles</strong> - The data exhibits rises and falls that aren’t neccassarily fixed in frequency. Often related to business cycles. This is most likely due to promotions.</li>
<li><strong>Troughs</strong> - Noticeable points where sales drop to zero, likely indicating days when stores were closed (e.g., holidays or operational breaks).</li>
</ul>
<div id="e8cb7a3c" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>sales<span class="op">=</span> (</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    train</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    .groupby([train.index, <span class="st">'Promo'</span>])  <span class="co"># Group by index and Promo</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    .agg({</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Sales'</span>: <span class="st">'sum'</span>,          <span class="co"># Sum "Sales"</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Customers'</span>: <span class="st">'sum'</span>       <span class="co"># Sum "Customers"</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>sales_6_months <span class="op">=</span> sales[<span class="st">'2013-01-01'</span>:<span class="st">'2013-06-01'</span>].reset_index()</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style<span class="op">=</span><span class="st">"darkgrid"</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">6</span>))</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Total Sales"</span>, color<span class="op">=</span><span class="st">'#858585'</span>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Date"</span>, color<span class="op">=</span><span class="st">'#858585'</span>)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Format y-axis</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>formatter <span class="op">=</span> FuncFormatter(millions)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>plt.gca().yaxis.set_major_formatter(formatter)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Title</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Daily Sales over 6 Months with Promotional Periods Highlighted"</span>, color <span class="op">=</span> <span class="st">'black'</span>,fontweight <span class="op">=</span> <span class="st">'bold'</span>)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>plt.annotate(</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Yearly Seasonality'</span>, </span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    xy<span class="op">=</span>(pd.to_datetime(<span class="st">'2013-12-10'</span>), <span class="dv">14000000</span>),  <span class="co"># Point near the 80% mark</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    xytext<span class="op">=</span>(date2num(pd.to_datetime(<span class="st">'2013-01-01'</span>)), <span class="dv">14300000</span>), </span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    arrowprops<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'black'</span>,edgecolor<span class="op">=</span><span class="st">'black'</span>, arrowstyle<span class="op">=</span><span class="st">"-&gt;"</span>, lw<span class="op">=</span><span class="fl">1.5</span>),</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">'black'</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the Sales time series</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span><span class="st">"Date"</span>, y<span class="op">=</span><span class="st">"Sales"</span>, data<span class="op">=</span>sales_6_months, label<span class="op">=</span><span class="st">"Total Sales"</span>)</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Highlight Promo periods</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> sales_6_months[sales_6_months[<span class="st">'Promo'</span>] <span class="op">==</span> <span class="dv">1</span>].iterrows():</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    plt.axvspan(row[<span class="st">'Date'</span>] <span class="op">-</span> pd.Timedelta(days<span class="op">=</span><span class="fl">0.5</span>), </span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>                row[<span class="st">'Date'</span>] <span class="op">+</span> pd.Timedelta(days<span class="op">=</span><span class="fl">0.5</span>), </span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">'orange'</span>, alpha<span class="op">=</span><span class="fl">0.2</span>, label<span class="op">=</span><span class="st">"Promo"</span> <span class="cf">if</span> _ <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">""</span>)</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RevisedIncrementalityModel-SARIMAX_files/figure-html/cell-6-output-1.png" width="985" height="529" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="eda-continued" class="level2">
<h2 class="anchored" data-anchor-id="eda-continued"><strong>EDA Continued</strong></h2>
<p>The <strong>Store</strong> dataset provides useful information that can explain the nature of <strong>Rossmans</strong> sales. We will now investigate the data by: - Plotting ECDF’s for Sales, Customers, and Sales per Customer. - Autocorrelation plots to see which factors influence Sales the most. - Breakdown Sales by <strong>Store Types</strong></p>
<section id="but-before-we-do-so-we-need-to-do-a-bit-of-data-cleaning." class="level4">
<h4 class="anchored" data-anchor-id="but-before-we-do-so-we-need-to-do-a-bit-of-data-cleaning."><strong>But before we do so, we need to do a bit of data cleaning.</strong></h4>
<div id="846ff1a8" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style <span class="op">=</span> <span class="st">"ticks"</span>)<span class="co"># to format into seaborn </span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a> <span class="co"># basic color for plots</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize <span class="op">=</span> (<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">311</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>cdf <span class="op">=</span> ECDF(train[<span class="st">'Sales'</span>])</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>plt.annotate(</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'~20</span><span class="sc">% o</span><span class="st">f days have no sales'</span>, </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    xy<span class="op">=</span>(<span class="dv">3500</span>, <span class="fl">0.2</span>),  <span class="co"># Point near the 80% mark</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    xytext<span class="op">=</span>(<span class="dv">7000</span>, <span class="fl">0.2</span>), </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    arrowprops<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'black'</span>,edgecolor<span class="op">=</span><span class="st">'black'</span>, arrowstyle<span class="op">=</span><span class="st">"-&gt;"</span>, lw<span class="op">=</span><span class="fl">1.5</span>),</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span>qualitative_colors[<span class="dv">0</span>]</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>plt.plot(cdf.x, cdf.y, label <span class="op">=</span> <span class="st">"statmodels"</span>, color <span class="op">=</span> qualitative_colors[<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Sales'</span>,color <span class="op">=</span> <span class="st">'#858585'</span>)<span class="op">;</span> </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'ECDF'</span>,color <span class="op">=</span> <span class="st">'#858585'</span>)<span class="op">;</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">312</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>cdf <span class="op">=</span> ECDF(train[<span class="st">'Customers'</span>])</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>plt.annotate(</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'~20</span><span class="sc">% o</span><span class="st">f days have no customers'</span>, </span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    xy<span class="op">=</span>(<span class="dv">350</span>, <span class="fl">0.2</span>),  <span class="co"># Point near the 80% mark</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    xytext<span class="op">=</span>(<span class="dv">900</span>, <span class="fl">0.2</span>), </span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    arrowprops<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'black'</span>,edgecolor<span class="op">=</span><span class="st">'black'</span>, arrowstyle<span class="op">=</span><span class="st">"-&gt;"</span>, lw<span class="op">=</span><span class="fl">1.5</span>),</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    fontsize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span>qualitative_colors[<span class="dv">0</span>]</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>plt.plot(cdf.x, cdf.y, label <span class="op">=</span> <span class="st">"statmodels"</span>, color <span class="op">=</span> qualitative_colors[<span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Customers'</span>,color <span class="op">=</span> <span class="st">'#858585'</span>)<span class="op">;</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'ECDF'</span>,color <span class="op">=</span> <span class="st">'#858585'</span>)<span class="op">;</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="co"># plot second ECDF  </span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">313</span>)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>cdf <span class="op">=</span> ECDF(train[<span class="st">'SalePerCustomer'</span>])</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>plt.plot(cdf.x, cdf.y, label <span class="op">=</span> <span class="st">"statmodels"</span>, color <span class="op">=</span> qualitative_colors[<span class="dv">2</span>])<span class="op">;</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Sale per Customer'</span>,color <span class="op">=</span> <span class="st">'#858585'</span>)<span class="op">;</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'ECDF'</span>,color <span class="op">=</span> <span class="st">'#858585'</span>)<span class="op">;</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RevisedIncrementalityModel-SARIMAX_files/figure-html/cell-7-output-1.png" width="1136" height="560" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="of-the-data-has-no-sales-we-have-a-column-open-which-indicates-whether-a-store-is-open-or-not.-these-days-will-be-removed-as-they-only-add-bias-to-the-data.-they-could-be-addressed-using-dummy-variableshowever-this-would-add-unneccesary-computation-time." class="level4">
<h4 class="anchored" data-anchor-id="of-the-data-has-no-sales-we-have-a-column-open-which-indicates-whether-a-store-is-open-or-not.-these-days-will-be-removed-as-they-only-add-bias-to-the-data.-they-could-be-addressed-using-dummy-variableshowever-this-would-add-unneccesary-computation-time."><strong>20% of the data has no sales</strong>, we have a column ‘Open’ which indicates whether a store is open or not. These days will be removed as they only add bias to the data. (They could be addressed using <a href="https://otexts.com/fpp3/useful-predictors.html#dummy-variables">dummy variables</a>however this would add unneccesary computation time. )</h4>
<div id="fb495315" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(train.shape[<span class="dv">0</span>])</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(train[(train.Open <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (train.Sales <span class="op">==</span> <span class="dv">0</span>)].shape[<span class="dv">0</span>])</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>train[(train.Open <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (train.Sales <span class="op">==</span> <span class="dv">0</span>)]<span class="sc">.</span>shape[<span class="dv">0</span>] <span class="op">/</span> train<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> train[(train[<span class="st">"Open"</span>] <span class="op">!=</span> <span class="dv">0</span>) <span class="op">&amp;</span> (train[<span class="st">'Sales'</span>] <span class="op">!=</span> <span class="dv">0</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1017209
172817
0.17</code></pre>
</div>
</div>
<ul>
<li>For Competition Distance we will impute null values with the median under the assumption that missing values are similar to those present.</li>
<li>The rest of the variables can be imputed with zeros for nulls.</li>
</ul>
<div id="9b67afae" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>store.info()</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>store[<span class="st">'CompetitionDistance'</span>].fillna(store[<span class="st">'CompetitionDistance'</span>].median(), inplace <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>store.fillna(<span class="dv">0</span>, inplace <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(store.groupby(<span class="st">'StoreType'</span>).size())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 1115 entries, 0 to 1114
Data columns (total 10 columns):
 #   Column                     Non-Null Count  Dtype  
---  ------                     --------------  -----  
 0   Store                      1115 non-null   int64  
 1   StoreType                  1115 non-null   object 
 2   Assortment                 1115 non-null   object 
 3   CompetitionDistance        1112 non-null   float64
 4   CompetitionOpenSinceMonth  761 non-null    float64
 5   CompetitionOpenSinceYear   761 non-null    float64
 6   Promo2                     1115 non-null   int64  
 7   Promo2SinceWeek            571 non-null    float64
 8   Promo2SinceYear            571 non-null    float64
 9   PromoInterval              571 non-null    object 
dtypes: float64(5), int64(2), object(3)
memory usage: 87.2+ KB
StoreType
a    602
b     17
c    148
d    348
dtype: int64</code></pre>
</div>
</div>
<div id="249d8044" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(train.shape)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Joining train set with an additional store information."</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># that are present in both train and store sets are merged together</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>train_store <span class="op">=</span> pd.merge(train.reset_index(), store, how<span class="op">=</span><span class="st">'inner'</span>, on<span class="op">=</span><span class="st">'Store'</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>train_store.set_index(<span class="st">'Date'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(844338, 13)
Joining train set with an additional store information.</code></pre>
</div>
</div>
</section>
</section>
<section id="merging-store-and-training-datasets" class="level2">
<h2 class="anchored" data-anchor-id="merging-store-and-training-datasets"><strong>Merging Store and Training datasets</strong></h2>
<p>Store and Training datasets have been merged to complete EDA.</p>
<div id="2ca2d381" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>train_store.groupby(<span class="st">'StoreType'</span>)[<span class="st">'Sales'</span>].describe()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>train_store.groupby(<span class="st">'StoreType'</span>)[[<span class="st">'Customers'</span>, <span class="st">'Sales'</span>]].<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Customers</th>
<th data-quarto-table-cell-role="th">Sales</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">StoreType</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">a</td>
<td>363541431</td>
<td>3165334859</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">b</td>
<td>31465616</td>
<td>159231395</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">c</td>
<td>92129705</td>
<td>783221426</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">d</td>
<td>156904995</td>
<td>1765392943</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="7065ceb9" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>promo_totals <span class="op">=</span> (</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    train_store.groupby([<span class="st">'StoreType'</span>, <span class="st">'Promo'</span>])</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">'TotalDays'</span>)  <span class="co"># Add a 'TotalDays' column</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.catplot(</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>train_store, </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">'Month'</span>, </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">'Sales'</span>, </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    col<span class="op">=</span><span class="st">'StoreType'</span>,  <span class="co"># Separate plots for each store type</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">'Promo'</span>,      <span class="co"># Separate lines for Promo = 0 and Promo = 1</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    kind<span class="op">=</span><span class="st">'point'</span>, </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span><span class="st">'plasma'</span>, </span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    sharey<span class="op">=</span><span class="va">True</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Add annotations for total Promo counts</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, store_type <span class="kw">in</span> <span class="bu">zip</span>(g.axes.flat, train_store[<span class="st">'StoreType'</span>].unique()):</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter totals for this StoreType</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    store_promo_totals <span class="op">=</span> promo_totals[promo_totals[<span class="st">'StoreType'</span>] <span class="op">==</span> store_type]</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(store_type)</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> promo <span class="kw">in</span> [<span class="dv">0</span>, <span class="dv">1</span>]:</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the total count of days for Promo = 0 or 1</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>        total_days <span class="op">=</span> store_promo_totals[</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>            store_promo_totals[<span class="st">'Promo'</span>] <span class="op">==</span> promo</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>        ][<span class="st">'TotalDays'</span>]</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> total_days.empty:</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Annotate the total days</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> store_type <span class="op">!=</span><span class="st">'d'</span>:</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>                ax.text(</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>                    x<span class="op">=</span><span class="dv">2</span>,  <span class="co"># Position text near the left edge</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>                    y<span class="op">=</span>ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.9</span> <span class="op">-</span> promo <span class="op">*</span> <span class="fl">0.7</span>,  <span class="co"># Offset for each promo line</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>                    s<span class="op">=</span><span class="ss">f"Promo </span><span class="sc">{</span>promo<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>total_days<span class="sc">.</span>values[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> days"</span>,</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>                    fontsize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span><span class="st">'black'</span>,</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>                    ha<span class="op">=</span><span class="st">'center'</span></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>                ax.text(</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>                    x<span class="op">=</span><span class="dv">2</span>,  <span class="co"># Position text near the left edge</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>                    y<span class="op">=</span>ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.6</span> <span class="op">-</span> promo <span class="op">*</span> <span class="fl">0.7</span>,  <span class="co"># Offset for each promo line</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>                    s<span class="op">=</span><span class="ss">f"Promo </span><span class="sc">{</span>promo<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>total_days<span class="sc">.</span>values[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> days"</span>,</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>                    fontsize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span><span class="st">'black'</span>,</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>                    ha<span class="op">=</span><span class="st">'center'</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RevisedIncrementalityModel-SARIMAX_files/figure-html/cell-12-output-1.png" width="1972" height="464" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="analyzing-sales-over-month-by-promo-1-promo-is-running-and-store-type-it-can-be-seen-that-promos-have-a-significant-effect-on-sales-for-all-store-types.-we-also-see-yearly-seasonality-this-will-be-addressed-soon." class="level4">
<h4 class="anchored" data-anchor-id="analyzing-sales-over-month-by-promo-1-promo-is-running-and-store-type-it-can-be-seen-that-promos-have-a-significant-effect-on-sales-for-all-store-types.-we-also-see-yearly-seasonality-this-will-be-addressed-soon.">Analyzing Sales over Month by Promo (1 = Promo is running) and Store Type, it can be seen that <strong>Promos have a significant effect on sales for all store types. We also see yearly seasonality, this will be addressed soon.</strong></h4>
<div id="22009098" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>promo_totals <span class="op">=</span> (</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    train_store.groupby([<span class="st">'StoreType'</span>, <span class="st">'Promo'</span>])</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">'TotalDays'</span>)  <span class="co"># Add a 'TotalDays' column</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.catplot(</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>train_store, </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">'Month'</span>, </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">'Customers'</span>, </span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    col<span class="op">=</span><span class="st">'StoreType'</span>,  <span class="co"># Separate plots for each store type</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">'Promo'</span>,      <span class="co"># Separate lines for Promo = 0 and Promo = 1</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    kind<span class="op">=</span><span class="st">'point'</span>, </span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span><span class="st">'plasma'</span>, </span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    sharey<span class="op">=</span><span class="va">True</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Add annotations for total Promo counts</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, store_type <span class="kw">in</span> <span class="bu">zip</span>(g.axes.flat, train_store[<span class="st">'StoreType'</span>].unique()):</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter totals for this StoreType</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    store_promo_totals <span class="op">=</span> promo_totals[promo_totals[<span class="st">'StoreType'</span>] <span class="op">==</span> store_type]</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(store_type)</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> promo <span class="kw">in</span> [<span class="dv">0</span>, <span class="dv">1</span>]:</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the total count of days for Promo = 0 or 1</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        total_days <span class="op">=</span> store_promo_totals[</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>            store_promo_totals[<span class="st">'Promo'</span>] <span class="op">==</span> promo</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>        ][<span class="st">'TotalDays'</span>]</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> total_days.empty:</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Annotate the total days</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> store_type <span class="op">!=</span><span class="st">'b'</span>:</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>                ax.text(</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>                    x<span class="op">=</span><span class="dv">2</span>,  <span class="co"># Position text near the left edge</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>                    y<span class="op">=</span>ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.9</span> <span class="op">-</span> promo <span class="op">*</span> <span class="dv">200</span>,  <span class="co"># Offset for each promo line</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>                    s<span class="op">=</span><span class="ss">f"Promo </span><span class="sc">{</span>promo<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>total_days<span class="sc">.</span>values[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> days"</span>,</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>                    fontsize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span><span class="st">'black'</span>,</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>                    ha<span class="op">=</span><span class="st">'center'</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>                ax.text(</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>                    x<span class="op">=</span><span class="dv">2</span>,  <span class="co"># Position text near the left edge</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>                    y<span class="op">=</span>ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.6</span> <span class="op">-</span> promo <span class="op">*</span> <span class="dv">200</span>,  <span class="co"># Offset for each promo line</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>                    s<span class="op">=</span><span class="ss">f"Promo </span><span class="sc">{</span>promo<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>total_days<span class="sc">.</span>values[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> days"</span>,</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>                    fontsize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span><span class="st">'black'</span>,</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>                    ha<span class="op">=</span><span class="st">'center'</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RevisedIncrementalityModel-SARIMAX_files/figure-html/cell-13-output-1.png" width="1973" height="464" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="analyzing-sales-and-customers-over-month-by-promo-1-promo-is-running-and-store-type-it-can-be-seen-that-promos-have-a-significant-effect-on-sales-for-all-store-types." class="level4">
<h4 class="anchored" data-anchor-id="analyzing-sales-and-customers-over-month-by-promo-1-promo-is-running-and-store-type-it-can-be-seen-that-promos-have-a-significant-effect-on-sales-for-all-store-types.">Analyzing Sales and Customers over Month by Promo (1 = Promo is running) and Store Type, it can be seen that <strong>Promos have a significant effect on sales for all store types.</strong></h4>
<div id="3c3d8b87" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sns.catplot(data = train_store, x = 'Month', y = "SalePerCustomer", </span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co">#                col = 'StoreType', # per store type in cols</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">#                palette = 'plasma',</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">#                hue = 'StoreType',</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">#                row = 'Promo', # per promo in the store in rows</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">#                kind = 'point') </span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co"># import seaborn as sns</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co"># import matplotlib.pyplot as plt</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co"># # Updated catplot code</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co"># sns.catplot(</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co">#     data=train_store, </span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     x='Month', </span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     y='SalePerCustomer', </span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     col='StoreType',  # Separate plots for each store type</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="co">#     hue='Promo',      # Separate lines for Promo = 0 and Promo = 1</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     kind='point', </span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co">#     palette='plasma', </span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="co">#     sharey=True  # Ensure consistent y-axis across all graphs</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="co"># # Show the plot</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.show()</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute total counts of Promo = 1 and Promo = 0 for each StoreType</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>promo_totals <span class="op">=</span> (</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    train_store.groupby([<span class="st">'StoreType'</span>, <span class="st">'Promo'</span>])</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">'TotalDays'</span>)  <span class="co"># Add a 'TotalDays' column</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> sns.catplot(</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>train_store, </span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">'Month'</span>, </span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">'SalePerCustomer'</span>, </span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    col<span class="op">=</span><span class="st">'StoreType'</span>,  <span class="co"># Separate plots for each store type</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    hue<span class="op">=</span><span class="st">'Promo'</span>,      <span class="co"># Separate lines for Promo = 0 and Promo = 1</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>    kind<span class="op">=</span><span class="st">'point'</span>, </span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>    palette<span class="op">=</span><span class="st">'plasma'</span>, </span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>    sharey<span class="op">=</span><span class="va">True</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Add annotations for total Promo counts</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, store_type <span class="kw">in</span> <span class="bu">zip</span>(g.axes.flat, train_store[<span class="st">'StoreType'</span>].unique()):</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter totals for this StoreType</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>    store_promo_totals <span class="op">=</span> promo_totals[promo_totals[<span class="st">'StoreType'</span>] <span class="op">==</span> store_type]</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(store_type)</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> promo <span class="kw">in</span> [<span class="dv">0</span>, <span class="dv">1</span>]:</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get the total count of days for Promo = 0 or 1</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>        total_days <span class="op">=</span> store_promo_totals[</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>            store_promo_totals[<span class="st">'Promo'</span>] <span class="op">==</span> promo</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>        ][<span class="st">'TotalDays'</span>]</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> total_days.empty:</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Annotate the total days</span></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> store_type <span class="op">!=</span><span class="st">'d'</span>:</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>                ax.text(</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>                    x<span class="op">=</span><span class="dv">2</span>,  <span class="co"># Position text near the left edge</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>                    y<span class="op">=</span>ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.9</span> <span class="op">-</span> promo <span class="op">*</span> <span class="fl">0.7</span>,  <span class="co"># Offset for each promo line</span></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>                    s<span class="op">=</span><span class="ss">f"Promo </span><span class="sc">{</span>promo<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>total_days<span class="sc">.</span>values[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> days"</span>,</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>                    fontsize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span><span class="st">'black'</span>,</span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>                    ha<span class="op">=</span><span class="st">'center'</span></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>                ax.text(</span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>                    x<span class="op">=</span><span class="dv">2</span>,  <span class="co"># Position text near the left edge</span></span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>                    y<span class="op">=</span>ax.get_ylim()[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">0.6</span> <span class="op">-</span> promo <span class="op">*</span> <span class="fl">0.7</span>,  <span class="co"># Offset for each promo line</span></span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a>                    s<span class="op">=</span><span class="ss">f"Promo </span><span class="sc">{</span>promo<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>total_days<span class="sc">.</span>values[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> days"</span>,</span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>                    fontsize<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>                    color<span class="op">=</span><span class="st">'black'</span>,</span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>                    ha<span class="op">=</span><span class="st">'center'</span></span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RevisedIncrementalityModel-SARIMAX_files/figure-html/cell-14-output-1.png" width="1973" height="464" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="ee20e36c" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>train <span class="op">=</span> pd.read_csv(<span class="st">"train.csv"</span>, </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                    parse_dates <span class="op">=</span> <span class="va">True</span>, index_col <span class="op">=</span> <span class="st">'Date'</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>store <span class="op">=</span> pd.read_csv(<span class="st">"store.csv"</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>train[<span class="st">'Year'</span>] <span class="op">=</span> train.index.year</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>train[<span class="st">'Month'</span>] <span class="op">=</span> train.index.month</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>train[<span class="st">'Day'</span>] <span class="op">=</span> train.index.day</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>train[<span class="st">'WeekOfYear'</span>] <span class="op">=</span> train.index.isocalendar().week </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co"># adding new variable</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>train[<span class="st">'SalePerCustomer'</span>] <span class="op">=</span> train[<span class="st">'Sales'</span>]<span class="op">/</span>train[<span class="st">'Customers'</span>]</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>train_store <span class="op">=</span> pd.merge(train.reset_index(), store, how<span class="op">=</span><span class="st">'inner'</span>, on<span class="op">=</span><span class="st">'Store'</span>)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>train_store.set_index(<span class="st">'Date'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="328aac5c" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>train_a <span class="op">=</span> train_store[train_store[<span class="st">'StoreType'</span>]<span class="op">==</span><span class="st">'a'</span>]</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(train_a)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>train_a <span class="op">=</span> train_a.sort_values(by<span class="op">=</span><span class="st">'Date'</span>,ascending<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>train_a[train_a[<span class="st">'Store'</span>]<span class="op">==</span><span class="dv">1114</span>].to_clipboard()</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>stores <span class="op">=</span> train_a[<span class="st">'Store'</span>].unique().tolist()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            Store  DayOfWeek  Sales  Customers  Open  Promo StateHoliday  \
Date                                                                       
2015-07-31      2          5   6064        625     1      1            0   
2015-07-31      3          5   8314        821     1      1            0   
2015-07-31      5          5   4822        559     1      1            0   
2015-07-31      6          5   5651        589     1      1            0   
2015-07-31      7          5  15344       1414     1      1            0   
...           ...        ...    ...        ...   ...    ...          ...   
2013-01-01   1107          2      0          0     0      0            a   
2013-01-01   1108          2      0          0     0      0            a   
2013-01-01   1111          2      0          0     0      0            a   
2013-01-01   1113          2      0          0     0      0            a   
2013-01-01   1114          2      0          0     0      0            a   

            SchoolHoliday  Year  Month  ...  SalePerCustomer  StoreType  \
Date                                    ...                               
2015-07-31              1  2015      7  ...         9.702400          a   
2015-07-31              1  2015      7  ...        10.126675          a   
2015-07-31              1  2015      7  ...         8.626118          a   
2015-07-31              1  2015      7  ...         9.594228          a   
2015-07-31              1  2015      7  ...        10.851485          a   
...                   ...   ...    ...  ...              ...        ...   
2013-01-01              1  2013      1  ...              NaN          a   
2013-01-01              1  2013      1  ...              NaN          a   
2013-01-01              1  2013      1  ...              NaN          a   
2013-01-01              1  2013      1  ...              NaN          a   
2013-01-01              1  2013      1  ...              NaN          a   

            Assortment CompetitionDistance CompetitionOpenSinceMonth  \
Date                                                                   
2015-07-31           a               570.0                      11.0   
2015-07-31           a             14130.0                      12.0   
2015-07-31           a             29910.0                       4.0   
2015-07-31           a               310.0                      12.0   
2015-07-31           c             24000.0                       4.0   
...                ...                 ...                       ...   
2013-01-01           a              1400.0                       6.0   
2013-01-01           a               540.0                       4.0   
2013-01-01           a              1900.0                       6.0   
2013-01-01           c              9260.0                       NaN   
2013-01-01           c               870.0                       NaN   

            CompetitionOpenSinceYear  Promo2  Promo2SinceWeek  \
Date                                                            
2015-07-31                    2007.0       1             13.0   
2015-07-31                    2006.0       1             14.0   
2015-07-31                    2015.0       0              NaN   
2015-07-31                    2013.0       0              NaN   
2015-07-31                    2013.0       0              NaN   
...                              ...     ...              ...   
2013-01-01                    2012.0       1             13.0   
2013-01-01                    2004.0       0              NaN   
2013-01-01                    2014.0       1             31.0   
2013-01-01                       NaN       0              NaN   
2013-01-01                       NaN       0              NaN   

            Promo2SinceYear    PromoInterval  
Date                                          
2015-07-31           2010.0  Jan,Apr,Jul,Oct  
2015-07-31           2011.0  Jan,Apr,Jul,Oct  
2015-07-31              NaN              NaN  
2015-07-31              NaN              NaN  
2015-07-31              NaN              NaN  
...                     ...              ...  
2013-01-01           2010.0  Jan,Apr,Jul,Oct  
2013-01-01              NaN              NaN  
2013-01-01           2013.0  Jan,Apr,Jul,Oct  
2013-01-01              NaN              NaN  
2013-01-01              NaN              NaN  

[551627 rows x 22 columns]</code></pre>
</div>
</div>
<div id="9e9a9035" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>promos <span class="op">=</span> {}</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> store <span class="kw">in</span> stores:</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    store_df <span class="op">=</span> train_a[train_a[<span class="st">'Store'</span>]<span class="op">==</span>store].copy()</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    store_df <span class="op">=</span> store_df.sort_values(by<span class="op">=</span><span class="st">'Date'</span>,ascending<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    promos[store] <span class="op">=</span> <span class="bu">list</span>(store_df[<span class="st">'Promo'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="883246d0" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>grouped_keys <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key, value <span class="kw">in</span> promos.items():</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert the list to a tuple (since lists are not hashable) and group keys</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    grouped_keys[<span class="bu">tuple</span>(value)].append(key)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> {value: keys <span class="cf">for</span> value, keys <span class="kw">in</span> grouped_keys.items() <span class="cf">if</span> <span class="bu">len</span>(keys) <span class="op">&gt;</span> <span class="dv">1</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="486bb52a" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>first_key <span class="op">=</span> <span class="bu">list</span>(result.keys())[<span class="dv">0</span>]</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(result[first_key])  <span class="co"># Output: 'a'</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>stores_a <span class="op">=</span> result[first_key]</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> train_a[train_a[<span class="st">'Store'</span>].isin(stores_a)]</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>exog <span class="op">=</span> df[df[<span class="st">'Store'</span>]<span class="op">==</span><span class="dv">1114</span>][[ <span class="st">'Promo'</span>, <span class="st">'SchoolHoliday'</span>, <span class="st">'StateHoliday'</span>,<span class="st">'DayOfWeek'</span>]]</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(exog)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>exog.to_clipboard()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1114, 375, 374, 364, 363, 360, 358, 376, 357, 351, 346, 344, 341, 355, 377, 378, 380, 403, 401, 400, 397, 396, 395, 392, 391, 390, 389, 388, 384, 383, 381, 340, 339, 338, 336, 303, 301, 300, 297, 296, 295, 294, 292, 290, 286, 285, 282, 278, 276, 304, 404, 308, 333, 332, 331, 330, 329, 328, 325, 324, 322, 320, 319, 315, 314, 311, 310, 307, 273, 405, 516, 513, 511, 510, 509, 508, 517, 507, 505, 502, 497, 506, 520, 524, 526, 546, 545, 544, 541, 538, 537, 536, 535, 533, 532, 531, 530, 528, 489, 488, 486, 448, 447, 446, 445, 439, 435, 433, 432, 426, 422, 418, 417, 416, 449, 451, 453, 484, 483, 480, 479, 475, 473, 470, 467, 466, 463, 462, 460, 459, 456, 454, 452, 272, 271, 270, 88, 87, 86, 84, 83, 90, 82, 79, 78, 74, 73, 71, 93, 95, 96, 124, 123, 122, 121, 119, 117, 116, 112, 110, 109, 107, 106, 105, 104, 102, 68, 67, 65, 62, 19, 17, 16, 14, 12, 11, 10, 9, 8, 7, 6, 5, 3, 2, 24, 125, 27, 30, 61, 59, 55, 53, 48, 47, 44, 42, 40, 39, 33, 28, 133, 134, 235, 233, 227, 226, 222, 220, 219, 212, 211, 209, 207, 206, 205, 236, 200, 237, 240, 269, 268, 266, 265, 264, 260, 257, 256, 253, 251, 248, 245, 238, 549, 198, 193, 163, 161, 157, 156, 153, 152, 148, 142, 140, 138, 195, 167, 187, 179, 177, 176, 173, 171, 170, 168, 166, 551, 1113, 557, 934, 933, 931, 930, 929, 935, 927, 923, 921, 918, 917, 924, 936, 938, 967, 966, 965, 964, 963, 959, 958, 956, 954, 953, 950, 949, 947, 946, 945, 916, 913, 911, 881, 880, 877, 876, 874, 873, 872, 870, 864, 863, 862, 856, 855, 853, 882, 969, 883, 886, 908, 907, 906, 905, 901, 898, 896, 895, 894, 892, 891, 885, 970, 972, 1076, 1075, 1073, 1072, 1071, 1069, 1066, 1064, 1063, 1060, 1058, 1054, 1053, 1052, 1077, 1079, 1084, 1111, 1108, 1106, 1100, 1099, 1098, 1096, 1095, 1091, 1090, 1088, 1086, 848, 1047, 1042, 1005, 1003, 998, 994, 992, 991, 986, 983, 980, 979, 976, 975, 1008, 1045, 1013, 1040, 1039, 1037, 1035, 1034, 1033, 1030, 1029, 1028, 1025, 1022, 1021, 1020, 1014, 1011, 846, 552, 841, 652, 651, 649, 647, 663, 643, 641, 639, 635, 632, 630, 645, 665, 699, 698, 696, 695, 692, 690, 688, 686, 685, 683, 681, 679, 675, 674, 625, 624, 623, 622, 586, 583, 582, 581, 580, 577, 570, 569, 566, 565, 563, 558, 844, 589, 700, 591, 593, 621, 617, 616, 614, 610, 609, 608, 607, 606, 603, 602, 597, 594, 592, 628, 705, 809, 808, 807, 802, 799, 798, 796, 791, 789, 788, 786, 784, 781, 780, 813, 779, 819, 703, 837, 836, 835, 834, 831, 830, 827, 826, 824, 823, 822, 821, 817, 811, 840, 737, 734, 732, 731, 727, 726, 722, 721, 720, 718, 715, 713, 709, 774, 743, 707, 749, 745, 770, 768, 767, 765, 764, 761, 773, 759, 758, 757, 756, 752, 751, 760]
            Promo  SchoolHoliday StateHoliday  DayOfWeek
Date                                                    
2013-01-01      0              1            a          2
2013-01-02      0              1            0          3
2013-01-03      0              1            0          4
2013-01-04      0              1            0          5
2013-01-05      0              0            0          6
...           ...            ...          ...        ...
2015-07-27      1              1            0          1
2015-07-28      1              1            0          2
2015-07-29      1              1            0          3
2015-07-30      1              1            0          4
2015-07-31      1              1            0          5

[942 rows x 4 columns]</code></pre>
</div>
</div>
<div id="aa53252d" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>df_agg <span class="op">=</span> df.groupby(df.index).agg(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    sales<span class="op">=</span>(<span class="st">'Sales'</span>, <span class="st">'sum'</span>),</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    customers<span class="op">=</span>(<span class="st">'Customers'</span>, <span class="st">'sum'</span>),</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    avg_salespercustomer<span class="op">=</span>(<span class="st">'SalePerCustomer'</span>, <span class="st">'mean'</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_agg)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>df_agg.to_clipboard()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              sales  customers  avg_salespercustomer
Date                                                
2013-01-01     2907        532              5.464286
2013-01-02  3404416     432946              7.994385
2013-01-03  3083285     392123              8.001257
2013-01-04  3145636     394606              8.095315
2013-01-05  2556636     317693              8.293373
...             ...        ...                   ...
2015-07-27  4823911     466917             10.546132
2015-07-28  4215867     432920              9.958732
2015-07-29  3888677     407142              9.787754
2015-07-30  4014507     418309              9.782409
2015-07-31  4671897     476425              9.970774

[942 rows x 3 columns]</code></pre>
</div>
</div>
<p>The above category plot shows interesting phenomena. ‘StoreType’ ‘C’ is closed on Sundays. We also see that ‘StoreType’ ‘D’ has either missing data for Sundays in November, or stores were closed on Sundays for November.</p>
</section>
<section id="for-simplicity-and-in-the-spirit-of-only-showcasing-the-effecacy-of-a-sarimax-model-on-extracting-insights-from-exogenous-variables-we-will-only-use-storetype-a-for-the-remainder-of-this-analysis." class="level4">
<h4 class="anchored" data-anchor-id="for-simplicity-and-in-the-spirit-of-only-showcasing-the-effecacy-of-a-sarimax-model-on-extracting-insights-from-exogenous-variables-we-will-only-use-storetype-a-for-the-remainder-of-this-analysis."><strong>For simplicity and in the spirit of only showcasing the effecacy of a SARIMAX model on extracting insights from exogenous variables, we will only use ‘StoreType’ ‘A’ for the remainder of this analysis.</strong></h4>
<p>Looking at the result of the category plot above, wo types of seasonality in the data is evident. The category plots from left -&gt; right show a decrease in sales from Monday -&gt; Sunday. Also visible is an increase in the mean sales over the 12 month period, highlighting yearly seasonality. This brings up an issue, that is SARIMA models only allow for 1 seasonality. However, we can implement a fourier series as exogenous variables to capture the yearly seasonality. In other words, we can capture yearly seasonality using a Fourier series, and capture weekly seasonalty using differencing in the SARIMA model. This will be done below.</p>
<p><strong>Please see this <a href="https://otexts.com/fpp3/complexseasonality.html#complexseasonality">link</a> for an explanation on this approach, developed by Rob J Hyndman.</strong></p>
</section>
</section>
<section id="my-model" class="level2">
<h2 class="anchored" data-anchor-id="my-model">My Model ——————————————————————————————————————————————————————</h2>
<div id="6bb4b31f" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>data<span class="op">=</span>df_agg</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># data['date'] = pd.to_datetime(data['date'], format='%d/%m/%Y')</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># #data['date2'] = pd.to_datetime(data['date'])</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co"># #data.to_csv('testing.csv',mode='w+')</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co"># data = data.set_index('date')</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>data.index <span class="op">=</span> pd.DatetimeIndex(data.index, freq<span class="op">=</span><span class="st">'D'</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co"># data=data[:'2024-01-27']</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co"># # Resample data on a weekly basis and sum the sales</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> data.resample(<span class="st">'D'</span>).<span class="bu">sum</span>()</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co"># # data.to_clipboard()</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>( <span class="bu">min</span>(data.index))</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>( <span class="bu">max</span>(data.index))</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="co"># #data.to_csv('testing')</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="co"># # print(type(data.index[0]))</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="co"># # print(data)</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="co"># #plot the sales data!</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="co"># # print(data['date'])</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="co"># #x=data.index</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="co"># #data=data['2021-06-01':]</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="co"># def millions_formatter(x, pos):</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     return f'{x / 1e6:.1f}M'</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="co"># data['sales'] = data['sales'].where(data.index.dayofweek != 6, 0)</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>data.loc[data.index.dayofweek <span class="op">==</span> <span class="dv">6</span>, <span class="st">'sales'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>y<span class="op">=</span>data[<span class="st">'sales'</span>]</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> date2num(data.index.to_pydatetime())</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> x.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)  <span class="co"># Reshape for sklearn which expects 2D array for features</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> data[<span class="st">'sales'</span>].values</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a><span class="co">#print(highest_points)</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>reg<span class="op">=</span> LinearRegression().fit(x,y)</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> reg.predict(x)</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">20</span>,<span class="dv">6</span>))</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>ax.plot(data.index,y,marker<span class="op">=</span><span class="st">'.'</span>, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, label<span class="op">=</span><span class="st">'Weekly'</span>)</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>ax.plot(data.index,y_pred, linestyle<span class="op">=</span><span class="st">'-'</span>, linewidth<span class="op">=</span><span class="dv">3</span>, label<span class="op">=</span><span class="st">'Weekly'</span>)</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>ax.yaxis.set_major_formatter(FuncFormatter(millions))</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Rossman Daily Sales'</span>,fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Weekly Sales ($)'</span>,fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Date'</span>,fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> np.array(y)</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>mse <span class="op">=</span> mean_squared_error(y, y_pred)</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate RMSE</span></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>rmse <span class="op">=</span> mean_squared_error(y, y_pred, squared<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate MAE</span></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>mae <span class="op">=</span> mean_absolute_error(y, y_pred)</span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate MAPE - Handling division by zero if y contains zeros</span></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>mape <span class="op">=</span> np.mean(np.<span class="bu">abs</span>((y <span class="op">-</span> y_pred) <span class="op">/</span> y)) <span class="op">*</span> <span class="dv">100</span> <span class="cf">if</span> np.<span class="bu">all</span>(y) <span class="cf">else</span> <span class="bu">float</span>(<span class="st">'inf'</span>)</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate R^2</span></span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> r2_score(y, y_pred)</span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a><span class="co">#Calculate the f1 score</span></span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MSE: </span><span class="sc">{:,.2f}</span><span class="st">'</span>.<span class="bu">format</span>(mse))</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'RMSE: </span><span class="sc">{:,.2f}</span><span class="st">'</span>.<span class="bu">format</span>(rmse))</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAE: </span><span class="sc">{:,.2f}</span><span class="st">'</span>.<span class="bu">format</span>(mae))</span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'MAPE: </span><span class="sc">{:.2f}</span><span class="st">%'</span>.<span class="bu">format</span>(mape))  <span class="co"># Percentage values don't typically include commas</span></span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'R^2: </span><span class="sc">{:.2f}</span><span class="st">'</span>.<span class="bu">format</span>(r2))</span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a><span class="co">#print(df.to_string())</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              sales  customers  avg_salespercustomer
Date                                                
2013-01-01     2907        532              5.464286
2013-01-02  3404416     432946              7.994385
2013-01-03  3083285     392123              8.001257
2013-01-04  3145636     394606              8.095315
2013-01-05  2556636     317693              8.293373
...             ...        ...                   ...
2015-07-27  4823911     466917             10.546132
2015-07-28  4215867     432920              9.958732
2015-07-29  3888677     407142              9.787754
2015-07-30  4014507     418309              9.782409
2015-07-31  4671897     476425              9.970774

[942 rows x 3 columns]
              sales  customers  avg_salespercustomer
Date                                                
2013-01-01     2907        532              5.464286
2013-01-02  3404416     432946              7.994385
2013-01-03  3083285     392123              8.001257
2013-01-04  3145636     394606              8.095315
2013-01-05  2556636     317693              8.293373
...             ...        ...                   ...
2015-07-27  4823911     466917             10.546132
2015-07-28  4215867     432920              9.958732
2015-07-29  3888677     407142              9.787754
2015-07-30  4014507     418309              9.782409
2015-07-31  4671897     476425              9.970774

[942 rows x 3 columns]
2013-01-01 00:00:00
2015-07-31 00:00:00</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="RevisedIncrementalityModel-SARIMAX_files/figure-html/cell-21-output-2.png" width="1579" height="533" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>MSE: 2,429,575,656,288.68
RMSE: 1,558,709.61
MAE: 1,143,395.16
MAPE: inf%
R^2: 0.00</code></pre>
</div>
</div>
<div id="b2090856" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co">#exog = exog.set_index('Date')</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>exog.index <span class="op">=</span> pd.DatetimeIndex(exog.index, freq<span class="op">=</span><span class="st">'D'</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(exog))</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co">#print(type(exog['campaign']))</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">#public_holidays = ['2020-12-25','2021-01-01','2021-12-25','2022-01-01','2022-12-25','2023-01-01','2023-12-25', '2024-01-01','2021-04-02','2021-04-04','2022-04-15','2022-04-17','2023-04-07','2023-04-09']  </span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert your date column to datetime format if it's not already</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co">#df['date'] = pd.to_datetime(df['date'])</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(exog)</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a binary indicator for public holidays</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co">#exog['is_public_holiday'] = exog.index.isin(public_holidays).astype(int)</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co">#print(exog.to_string())</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(exog))</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(y))</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>exog[<span class="st">'StateHoliday'</span>] <span class="op">=</span> exog[<span class="st">'StateHoliday'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="dv">0</span> <span class="cf">if</span> x <span class="op">==</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">1</span>)</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(exog[<span class="st">'StateHoliday'</span>].unique())</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>exog[<span class="st">'StateHoliday'</span>] <span class="op">=</span> pd.to_numeric(exog[<span class="st">'StateHoliday'</span>], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>exog[<span class="st">'SchoolHoliday'</span>] <span class="op">=</span> pd.to_numeric(exog[<span class="st">'SchoolHoliday'</span>], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>exog[<span class="st">'DayOfWeek'</span>] <span class="op">=</span> exog[<span class="st">'DayOfWeek'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="dv">1</span> <span class="cf">if</span> x <span class="op">==</span> <span class="dv">7</span> <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="co">#exog.loc[exog.index &lt; '2023-01-01', 'weekend'] = 0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>942
            Promo  SchoolHoliday StateHoliday  DayOfWeek
Date                                                    
2013-01-01      0              1            a          2
2013-01-02      0              1            0          3
2013-01-03      0              1            0          4
2013-01-04      0              1            0          5
2013-01-05      0              0            0          6
...           ...            ...          ...        ...
2015-07-27      1              1            0          1
2015-07-28      1              1            0          2
2015-07-29      1              1            0          3
2015-07-30      1              1            0          4
2015-07-31      1              1            0          5

[942 rows x 4 columns]
942
942
[1 0]</code></pre>
</div>
</div>
<div id="b6ff0dea" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">#adding in fourier terms to the model.</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"># seasonality=365</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co"># n=1224</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co"># t=1</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co"># # Create Fourier terms for weekly seasonality</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co"># def create_fourier_terms(t, period, num_terms):</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     terms = []</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     for i in range(1, num_terms + 1):</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co">#         terms.append(np.sin(2 * np.pi * i * t / period))</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co">#         terms.append(np.cos(2 * np.pi * i * t / period))</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     return np.column_stack(terms)</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="co"># num_fourier_terms = 4</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="co"># fourier_terms = create_fourier_terms(t, seasonality, num_fourier_terms)</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fourier_terms(data, period, K):</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `data` is the DataFrame, `period` is the seasonal period (e.g., 365 for yearly),</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and `K` is the number of sine/cosine term pairs</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    T <span class="op">=</span> <span class="bu">len</span>(data)</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> np.arange(<span class="dv">1</span>, T <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    fourier_terms <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>data.index)</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, K <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>        fourier_terms[<span class="ss">f'sin_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> np.sin(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> k <span class="op">*</span> t <span class="op">/</span> period)</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>        fourier_terms[<span class="ss">f'cos_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> np.cos(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> k <span class="op">*</span> t <span class="op">/</span> period)</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fourier_terms</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>K <span class="op">=</span> <span class="dv">6</span>  <span class="co"># Number of terms; adjust based on your model's needs</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>period <span class="op">=</span> <span class="dv">365</span>  <span class="co"># Yearly seasonality</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>fourier_terms_df <span class="op">=</span> fourier_terms(data, period, K)</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(fourier_terms_df)</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>combined_exog <span class="op">=</span> pd.concat([exog, fourier_terms_df], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(combined_exog)</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>exog<span class="op">=</span>combined_exog</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               sin_1     cos_1     sin_2     cos_2     sin_3     cos_3  \
Date                                                                     
2013-01-01  0.017213  0.999852  0.034422  0.999407  0.051620  0.998667   
2013-01-02  0.034422  0.999407  0.068802  0.997630  0.103102  0.994671   
2013-01-03  0.051620  0.998667  0.103102  0.994671  0.154309  0.988023   
2013-01-04  0.068802  0.997630  0.137279  0.990532  0.205104  0.978740   
2013-01-05  0.085965  0.996298  0.171293  0.985220  0.255353  0.966848   
...              ...       ...       ...       ...       ...       ...   
2015-07-27 -0.425000 -0.905193  0.769415  0.638749 -0.967938 -0.251190   
2015-07-28 -0.440519 -0.897743  0.790946  0.611886 -0.979614 -0.200891   
2015-07-29 -0.455907 -0.890028  0.811539  0.584298 -0.988678 -0.150055   
2015-07-30 -0.471160 -0.882048  0.831171  0.556017 -0.995105 -0.098820   
2015-07-31 -0.486273 -0.873807  0.849817  0.527078 -0.998880 -0.047321   

               sin_4     cos_4     sin_5     cos_5     sin_6     cos_6  
Date                                                                    
2013-01-01  0.068802  0.997630  0.085965  0.996298  0.103102  0.994671  
2013-01-02  0.137279  0.990532  0.171293  0.985220  0.205104  0.978740  
2013-01-03  0.205104  0.978740  0.255353  0.966848  0.304921  0.952378  
2013-01-04  0.271958  0.962309  0.337523  0.941317  0.401488  0.915864  
2013-01-05  0.337523  0.941317  0.417194  0.908818  0.493776  0.869589  
...              ...       ...       ...       ...       ...       ...  
2015-07-27  0.982927 -0.183998 -0.811539  0.584298  0.486273 -0.873807  
2015-07-28  0.967938 -0.251190 -0.758306  0.651899  0.393590 -0.919286  
2015-07-29  0.948362 -0.317191 -0.699458  0.714673  0.296713 -0.954967  
2015-07-30  0.924291 -0.381689 -0.635432  0.772157  0.196673 -0.980469  
2015-07-31  0.895839 -0.444378 -0.566702  0.823923  0.094537 -0.995521  

[942 rows x 12 columns]
            Promo  SchoolHoliday  StateHoliday  DayOfWeek     sin_1     cos_1  \
Date                                                                            
2013-01-01      0              1             1          0  0.017213  0.999852   
2013-01-02      0              1             1          0  0.034422  0.999407   
2013-01-03      0              1             1          0  0.051620  0.998667   
2013-01-04      0              1             1          0  0.068802  0.997630   
2013-01-05      0              0             1          0  0.085965  0.996298   
...           ...            ...           ...        ...       ...       ...   
2015-07-27      1              1             1          0 -0.425000 -0.905193   
2015-07-28      1              1             1          0 -0.440519 -0.897743   
2015-07-29      1              1             1          0 -0.455907 -0.890028   
2015-07-30      1              1             1          0 -0.471160 -0.882048   
2015-07-31      1              1             1          0 -0.486273 -0.873807   

               sin_2     cos_2     sin_3     cos_3     sin_4     cos_4  \
Date                                                                     
2013-01-01  0.034422  0.999407  0.051620  0.998667  0.068802  0.997630   
2013-01-02  0.068802  0.997630  0.103102  0.994671  0.137279  0.990532   
2013-01-03  0.103102  0.994671  0.154309  0.988023  0.205104  0.978740   
2013-01-04  0.137279  0.990532  0.205104  0.978740  0.271958  0.962309   
2013-01-05  0.171293  0.985220  0.255353  0.966848  0.337523  0.941317   
...              ...       ...       ...       ...       ...       ...   
2015-07-27  0.769415  0.638749 -0.967938 -0.251190  0.982927 -0.183998   
2015-07-28  0.790946  0.611886 -0.979614 -0.200891  0.967938 -0.251190   
2015-07-29  0.811539  0.584298 -0.988678 -0.150055  0.948362 -0.317191   
2015-07-30  0.831171  0.556017 -0.995105 -0.098820  0.924291 -0.381689   
2015-07-31  0.849817  0.527078 -0.998880 -0.047321  0.895839 -0.444378   

               sin_5     cos_5     sin_6     cos_6  
Date                                                
2013-01-01  0.085965  0.996298  0.103102  0.994671  
2013-01-02  0.171293  0.985220  0.205104  0.978740  
2013-01-03  0.255353  0.966848  0.304921  0.952378  
2013-01-04  0.337523  0.941317  0.401488  0.915864  
2013-01-05  0.417194  0.908818  0.493776  0.869589  
...              ...       ...       ...       ...  
2015-07-27 -0.811539  0.584298  0.486273 -0.873807  
2015-07-28 -0.758306  0.651899  0.393590 -0.919286  
2015-07-29 -0.699458  0.714673  0.296713 -0.954967  
2015-07-30 -0.635432  0.772157  0.196673 -0.980469  
2015-07-31 -0.566702  0.823923  0.094537 -0.995521  

[942 rows x 16 columns]</code></pre>
</div>
</div>
</section>
<section id="sales-data-fitting-a-linear-regression-model" class="level2">
<h2 class="anchored" data-anchor-id="sales-data-fitting-a-linear-regression-model">Sales Data: Fitting a Linear Regression Model</h2>
<div id="afd4d458" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data[<span class="st">'sales'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Date
2013-01-01       2907
2013-01-02    3404416
2013-01-03    3083285
2013-01-04    3145636
2013-01-05    2556636
               ...   
2015-07-27    4823911
2015-07-28    4215867
2015-07-29    3888677
2015-07-30    4014507
2015-07-31    4671897
Freq: D, Name: sales, Length: 942, dtype: int64</code></pre>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>